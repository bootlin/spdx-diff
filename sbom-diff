#!/usr/bin/env python3
#
# SPDX-License-Identifier: GPL-2.0

import json
import logging
import sys
import os
import re
from argparse import ArgumentParser
from datetime import datetime
from typing import Dict, Set, Tuple, List, Any

logging.basicConfig(level=logging.INFO, format="[%(levelname)s] %(message)s")


def normalize_package_name(name: str) -> Tuple[str, str]:
    """
    Normalize package names, especially for kernel and kernel-modules.

    Returns:
        tuple: (normalized_name, version_suffix)

    Examples:
        "kernel-6.12.43-00469-g647daef97a89" -> ("kernel", "6.12.43-00469-g647daef97a89")
        "kernel-module-8021q-6.12.43-00469-g647daef97a89" -> ("kernel-module-8021q", "6.12.43-00469-g647daef97a89")
    """
    # Pattern to match kernel version suffixes like "6.12.43-00469-g647daef97a89"
    kernel_version_pattern = r'-(\d+\.\d+\.\d+(?:-[a-zA-Z0-9]+-\d+-g[a-f0-9]+)?)$'

    match = re.search(kernel_version_pattern, name)
    if match:
        version_suffix = match.group(1)
        normalized = name[:match.start()]
        return normalized, version_suffix

    return name, ""


def extract_spdx_data(
    json_path: str, ignore_proprietary: bool = False
) -> Tuple[Dict[str, str], Dict[str, Any], Dict[str, Dict[str, str]]]:
    """
    Extract SPDX package data, kernel CONFIG options, and PACKAGECONFIG entries from a JSON file.
    Kernel packages are automatically normalized.

    Args:
        json_path: Path to the SPDX3 JSON file
        ignore_proprietary: Whether to skip proprietary packages

    Returns:
        tuple[dict, dict, dict]:
            - packages: mapping of package names to versions
            - config: mapping of CONFIG_* keys to their values
            - packageconfig_dict: mapping of package names to their PACKAGECONFIG features
    """
    logging.info(f"Opening SPDX file: {json_path}")
    try:
        with open(json_path, "r", encoding="utf-8") as f:
            data = json.load(f)
    except (json.JSONDecodeError, IOError) as e:
        logging.error(f"Failed to read or parse {json_path}: {e}")
        return {}, {}, {}

    graph = (
        data.get("graph")
        or data.get("@graph")
        or (data if isinstance(data, list) else [])
    )
    if not isinstance(graph, list):
        logging.error("SPDX3 file format is not recognized.")
        return {}, {}, {}

    logging.info(f"Found {len(graph)} elements in the SPDX3 document.")

    packages: Dict[str, str] = {}
    config: Dict[str, Any] = {}
    packageconfig_dict: Dict[str, Dict[str, str]] = {}
    build_count = 0

    for item in graph:
        # Extract packages
        if item.get("type") == "software_Package":
            name = item.get("name")
            version = item.get("software_packageVersion")
            license_expr = item.get("simplelicensing_licenseExpression", "")

            if not name or not version:
                continue
            if ignore_proprietary and license_expr == "LicenseRef-Proprietary":
                logging.info(f"Ignoring proprietary package: {name}")
                continue
            if (
                name.endswith((".tar.gz", ".tar.xz", ".tar.bz2", ".zip"))
                or "git" in name
                or name.startswith("http")
            ):
                continue

            # Always normalize kernel package names
            if name.startswith("kernel-") or name == "kernel":
                normalized_name, version_suffix = normalize_package_name(name)
                packages[normalized_name] = version
            else:
                packages[name] = version

        # Extract kernel config and PACKAGECONFIG
        if item.get("type", "").endswith("build_Build"):
            build_count += 1

            build_name = item.get("name", "")
            pkg_name = None
            if ":" in build_name:
                pkg_name = build_name.split(":")[0]

            params = item.get("build_parameter", [])
            if not isinstance(params, list):
                continue
            for param in params:
                if not isinstance(param, dict):
                    continue
                key = param.get("key")
                value = param.get("value")
                if not key or value is None:
                    continue

                if key.startswith("CONFIG_"):
                    config[key] = value
                elif key.startswith("PACKAGECONFIG"):
                    if pkg_name:
                        if pkg_name not in packageconfig_dict:
                            packageconfig_dict[pkg_name] = {}

                        if ":" in key:
                            feature = key.split(":", 1)[1]
                            packageconfig_dict[pkg_name][feature] = value

    if build_count == 0:
        logging.warning("No build_Build objects found.")

    logging.info(
        f"Extracted {len(packages)} packages, {len(config)} CONFIG_*, "
        f"and {len(packageconfig_dict)} packages with PACKAGECONFIG entries."
    )
    return packages, config, packageconfig_dict


def compare_dicts(
    ref: Dict[str, Any], new: Dict[str, Any]
) -> Tuple[Dict[str, Any], Dict[str, Any], Dict[str, Any]]:
    """
    Compare two dictionaries and return added, removed, and changed items.

    Args:
        ref: Reference dictionary
        new: New dictionary to compare

    Returns:
        tuple[dict, dict, dict]: added, removed, changed items
    """
    added = {k: v for k, v in new.items() if k not in ref}
    removed = {k: v for k, v in ref.items() if k not in new}
    changed = {
        k: {"from": ref[k], "to": new[k]} for k in ref if k in new and ref[k] != new[k]
    }
    return added, removed, changed


def compare_packageconfig(
    ref_pcfg: Dict[str, Dict[str, str]], new_pcfg: Dict[str, Dict[str, str]]
) -> Tuple[Dict[str, Dict[str, str]], Dict[str, Dict[str, str]], Dict[str, Dict[str, Any]]]:
    """
    Compare PACKAGECONFIG dictionaries.

    Args:
        ref_pcfg: Reference PACKAGECONFIG mapping
        new_pcfg: New PACKAGECONFIG mapping

    Returns:
        tuple: added packages, removed packages, changed features per package
    """
    added_pkgs = {k: v for k, v in new_pcfg.items() if k not in ref_pcfg}
    removed_pkgs = {k: v for k, v in ref_pcfg.items() if k not in new_pcfg}

    changed_pkgs = {}
    for pkg in ref_pcfg:
        if pkg in new_pcfg:
            ref_features = ref_pcfg[pkg]
            new_features = new_pcfg[pkg]

            added_features = {k: v for k, v in new_features.items() if k not in ref_features}
            removed_features = {k: v for k, v in ref_features.items() if k not in new_features}
            changed_features = {
                k: {"from": ref_features[k], "to": new_features[k]}
                for k in ref_features
                if k in new_features and ref_features[k] != new_features[k]
            }

            if added_features or removed_features or changed_features:
                changed_pkgs[pkg] = {
                    "added": added_features,
                    "removed": removed_features,
                    "changed": changed_features,
                }

    return added_pkgs, removed_pkgs, changed_pkgs


def print_diff(
    title: str, added: Any, removed: Any, changed: Any = None,
    show_all: bool = False, show_added: bool = True,
    show_removed: bool = True, show_changed: bool = True
) -> None:
    """
    Print differences between items.

    Args:
        title: Section title
        added: Added items
        removed: Removed items
        changed: Changed items
        show_all: Whether to show even if empty
        show_added: Whether to show added items
        show_removed: Whether to show removed items
        show_changed: Whether to show changed items
    """
    if show_added and (show_all or added):
        print(f"\n{title} - Added:")
        for k in sorted(added) if isinstance(added, dict) else added:
            print(f" + {k}" if isinstance(added, list) else f" + {k}: {added[k]}")

    if show_removed and (show_all or removed):
        print(f"\n{title} - Removed:")
        for k in sorted(removed) if isinstance(removed, dict) else removed:
            print(f" - {k}" if isinstance(removed, list) else f" - {k}: {removed[k]}")

    if show_changed and changed and (show_all or changed):
        print(f"\n{title} - Changed:")
        for k in sorted(changed):
            print(f" ~ {k}: {changed[k]['from']} -> {changed[k]['to']}")


def print_packageconfig_diff(
    added: Dict[str, Dict[str, str]],
    removed: Dict[str, Dict[str, str]],
    changed: Dict[str, Dict[str, Any]],
    show_all: bool = False,
    show_added: bool = True,
    show_removed: bool = True,
    show_changed: bool = True
) -> None:
    """
    Print PACKAGECONFIG differences.

    Args:
        added: Added packages with their features
        removed: Removed packages with their features
        changed: Changed packages with feature differences
        show_all: Whether to show even if empty
        show_added: Whether to show added items
        show_removed: Whether to show removed items
        show_changed: Whether to show changed items
    """
    if show_added and (show_all or added):
        print(f"\nPACKAGECONFIG - Added Packages:")
        for pkg in sorted(added):
            print(f" + {pkg}:")
            for feature, value in sorted(added[pkg].items()):
                print(f"     {feature}: {value}")

    if show_removed and (show_all or removed):
        print(f"\nPACKAGECONFIG - Removed Packages:")
        for pkg in sorted(removed):
            print(f" - {pkg}:")
            for feature, value in sorted(removed[pkg].items()):
                print(f"     {feature}: {value}")

    if show_changed and (show_all or changed):
        print(f"\nPACKAGECONFIG - Changed Packages:")
        for pkg in sorted(changed):
            print(f" ~ {pkg}:")
            pkg_changes = changed[pkg]
            if pkg_changes.get("added"):
                for feature, value in sorted(pkg_changes["added"].items()):
                    print(f"     + {feature}: {value}")
            if pkg_changes.get("removed"):
                for feature, value in sorted(pkg_changes["removed"].items()):
                    print(f"     - {feature}: {value}")
            if pkg_changes.get("changed"):
                for feature, change in sorted(pkg_changes["changed"].items()):
                    print(f"     ~ {feature}: {change['from']} -> {change['to']}")


def print_summary(
    pkg_diff: Tuple[Dict[str, Any], Dict[str, Any], Dict[str, Any]],
    cfg_diff: Tuple[Dict[str, Any], Dict[str, Any], Dict[str, Any]],
    pcfg_diff: Tuple[Dict[str, Dict[str, str]], Dict[str, Dict[str, str]], Dict[str, Dict[str, Any]]],
) -> None:
    """
    Print summary statistics of differences.

    Args:
        pkg_diff: Package differences
        cfg_diff: Kernel config differences
        pcfg_diff: PACKAGECONFIG differences
    """
    print("\nSPDX-SBOM-Diff Summary:\n")

    print(f"Packages:")
    print(f"  Added:   {len(pkg_diff[0])}")
    print(f"  Removed: {len(pkg_diff[1])}")
    print(f"  Changed: {len(pkg_diff[2])}")

    print(f"\nKernel Config:")
    print(f"  Added:   {len(cfg_diff[0])}")
    print(f"  Removed: {len(cfg_diff[1])}")
    print(f"  Changed: {len(cfg_diff[2])}")

    print(f"\nPACKAGECONFIG:")
    print(f"  Packages Added:   {len(pcfg_diff[0])}")
    print(f"  Packages Removed: {len(pcfg_diff[1])}")
    print(f"  Packages Changed: {len(pcfg_diff[2])}")

    # Count total feature changes
    total_features_added = sum(len(v.get("added", {})) for v in pcfg_diff[2].values())
    total_features_removed = sum(len(v.get("removed", {})) for v in pcfg_diff[2].values())
    total_features_changed = sum(len(v.get("changed", {})) for v in pcfg_diff[2].values())

    if total_features_added or total_features_removed or total_features_changed:
        print(f"  Features Added:   {total_features_added}")
        print(f"  Features Removed: {total_features_removed}")
        print(f"  Features Changed: {total_features_changed}")

    print()


def write_diff_to_json(
    pkg_diff: Tuple[Dict[str, Any], Dict[str, Any], Dict[str, Any]],
    cfg_diff: Tuple[Dict[str, Any], Dict[str, Any], Dict[str, Any]],
    pcfg_diff: Tuple[Dict[str, Dict[str, str]], Dict[str, Dict[str, str]], Dict[str, Dict[str, Any]]],
    output_file: str,
) -> None:
    """
    Write diff results to a JSON file.

    Args:
        pkg_diff: Differences for packages
        cfg_diff: Differences for kernel config
        pcfg_diff: Differences for PACKAGECONFIG
        output_file: File path to write JSON
    """
    logging.info(f"Writing diff results to {output_file}")
    delta = {
        "package_diff": {
            "added": dict(sorted(pkg_diff[0].items())),
            "removed": dict(sorted(pkg_diff[1].items())),
            "changed": dict(sorted(pkg_diff[2].items())),
        },
        "kernel_config_diff": {
            "added": dict(sorted(cfg_diff[0].items())),
            "removed": dict(sorted(cfg_diff[1].items())),
            "changed": dict(sorted(cfg_diff[2].items())),
        },
        "packageconfig_diff": {
            "added": dict(sorted(pcfg_diff[0].items())),
            "removed": dict(sorted(pcfg_diff[1].items())),
            "changed": dict(sorted(pcfg_diff[2].items())),
        },
    }
    with open(output_file, "w", encoding="utf-8") as f:
        json.dump(delta, f, indent=2, ensure_ascii=False)


def main() -> None:
    """
    Main entry point: parse arguments, extract SPDX data, compare, and print/write diffs.
    """
    parser = ArgumentParser(
        description="Compare SPDX3 JSON files for packages, kernel config, and PACKAGECONFIG"
    )
    parser.add_argument("reference", help="Reference SPDX3 JSON file")
    parser.add_argument("new", help="New SPDX3 JSON file")
    parser.add_argument(
        "--full",
        action="store_true",
        help="Show full diff output (added, removed, changed)",
    )
    parser.add_argument(
        "--output", default=None, help="Optional output file name (JSON)"
    )
    parser.add_argument(
        "--ignore-proprietary",
        action="store_true",
        help="Ignore packages with LicenseRef-Proprietary",
    )
    parser.add_argument(
        "--summary",
        action="store_true",
        help="Show only summary statistics without detailed differences",
    )
    parser.add_argument(
        "--format",
        choices=["text", "json", "both"],
        default="both",
        help="Output format: text (console only), json (file only), or both (default)",
    )

    # Output filtering options
    parser.add_argument(
        "--show-added",
        action="store_true",
        help="Show only added items",
    )
    parser.add_argument(
        "--show-removed",
        action="store_true",
        help="Show only removed items",
    )
    parser.add_argument(
        "--show-changed",
        action="store_true",
        help="Show only changed items",
    )
    parser.add_argument(
        "--show-packages",
        action="store_true",
        help="Show only package differences",
    )
    parser.add_argument(
        "--show-config",
        action="store_true",
        help="Show only kernel config differences",
    )
    parser.add_argument(
        "--show-packageconfig",
        action="store_true",
        help="Show only PACKAGECONFIG differences",
    )

    args = parser.parse_args()

    if not os.path.isfile(args.reference) or not os.path.isfile(args.new):
        logging.error("One or both input files do not exist.")
        sys.exit(1)

    timestamp = datetime.now().strftime("%Y%m%d-%H%M%S")
    if args.output is None:
        args.output = f"spdx_diff_{timestamp}.json"

    # Determine what to show based on flags
    # If no specific show flags are set, show everything
    show_added = args.show_added or not (args.show_added or args.show_removed or args.show_changed)
    show_removed = args.show_removed or not (args.show_added or args.show_removed or args.show_changed)
    show_changed = args.show_changed or not (args.show_added or args.show_removed or args.show_changed)

    show_packages = args.show_packages or not (args.show_packages or args.show_config or args.show_packageconfig)
    show_config = args.show_config or not (args.show_packages or args.show_config or args.show_packageconfig)
    show_packageconfig = args.show_packageconfig or not (args.show_packages or args.show_config or args.show_packageconfig)

    ref_pkgs, ref_cfg, ref_pcfg = extract_spdx_data(
        args.reference, ignore_proprietary=args.ignore_proprietary
    )
    new_pkgs, new_cfg, new_pcfg = extract_spdx_data(
        args.new, ignore_proprietary=args.ignore_proprietary
    )

    pkg_diff = compare_dicts(ref_pkgs, new_pkgs)
    cfg_diff = compare_dicts(ref_cfg, new_cfg)
    pcfg_diff = compare_packageconfig(ref_pcfg, new_pcfg)

    # Print summary or full output
    if args.summary:
        print_summary(pkg_diff, cfg_diff, pcfg_diff)
    elif args.format in ["text", "both"]:
        if show_packages:
            print_diff("Packages", *pkg_diff, show_all=args.full,
                      show_added=show_added, show_removed=show_removed, show_changed=show_changed)
        if show_config:
            print_diff("Kernel Config", *cfg_diff, show_all=args.full,
                      show_added=show_added, show_removed=show_removed, show_changed=show_changed)
        if show_packageconfig:
            print_packageconfig_diff(*pcfg_diff, show_all=args.full,
                                    show_added=show_added, show_removed=show_removed, show_changed=show_changed)

    if args.format in ["json", "both"]:
        write_diff_to_json(pkg_diff, cfg_diff, pcfg_diff, args.output)


if __name__ == "__main__":
    main()
